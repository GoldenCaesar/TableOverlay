<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Video Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            --bg-color: #111827;
            --panel-color: #1f2937;
            --border-color: #374151;
            --text-color: #d1d5db;
            --text-secondary: #9ca3af;
            --accent-color: #3b82f6;
            --module-color: #2563eb;
        }
        .aspect-9-16 {
            aspect-ratio: 9 / 16;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--panel-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .dragging { opacity: 0.5; border: 2px dashed var(--accent-color); }
        .file-explorer-placeholder, .timeline-placeholder, .module-placeholder {
            border: 2px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            height: 100%;
            text-align: center;
            padding: 1rem;
        }
        .timeline-placeholder { min-height: 6rem; }
        .file-explorer-placeholder { min-height: 10rem; }
        .no-select { user-select: none; -webkit-user-select: none; }
        .checkerboard {
            background-color: #1f2937;
            background-image:
                linear-gradient(45deg, #374151 25%, transparent 25%),
                linear-gradient(-45deg, #374151 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #374151 75%),
                linear-gradient(-45deg, transparent 75%, #374151 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300 flex flex-col h-screen p-4 sm:p-6 lg:p-8 gap-4 no-select" style="background-color: var(--bg-color);">

    <!-- Main Layout Container -->
    <div class="flex-grow flex flex-col md:flex-row gap-4 w-full max-w-7xl mx-auto overflow-hidden">
        
        <!-- Left & Center Column -->
        <div class="flex-grow flex flex-col gap-4">
            <!-- Video Display -->
            <div class="flex justify-center">
                <div class="w-full max-w-sm bg-black rounded-lg shadow-2xl overflow-hidden">
                    <div id="video-container" class="aspect-9-16 w-full flex items-center justify-center checkerboard">
                        <video id="video-player" class="w-full h-full object-contain" poster="https://placehold.co/360x640/1f2937/4b5563?text=Player"></video>
                        <img id="image-player" class="w-full h-full object-contain hidden" />
                    </div>
                </div>
            </div>

            <!-- Timeline and Controls -->
            <div class="w-full flex items-center gap-4 bg-gray-800 p-3 rounded-lg shadow-lg" style="background-color: var(--panel-color);">
                <button id="save-module-btn" class="p-2 bg-gray-600 hover:bg-gray-700 rounded-md" title="Save Timeline as Module">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                </button>
                <div id="timeline" class="flex-grow h-24 bg-gray-900 rounded-md p-2 flex items-center gap-1 overflow-x-auto" style="background-color: var(--bg-color);">
                     <div id="timeline-placeholder" class="timeline-placeholder w-full">
                        <p>Drag files from the explorer here</p>
                    </div>
                </div>
                <div id="controls" class="flex-shrink-0 flex items-center gap-2">
                    <button id="skip-btn" class="w-12 h-12 bg-gray-600 hover:bg-gray-700 text-white rounded-full flex items-center justify-center transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-500" title="Skip to next clip">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                    </button>
                    <button id="play-stop-btn" class="w-16 h-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center transition-all duration-300 shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500" style="background-color: var(--accent-color);">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                        <svg id="stop-icon" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Module Explorer -->
        <div class="w-full md:w-64 flex-shrink-0 bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col" style="background-color: var(--panel-color);">
             <h2 class="text-lg font-semibold mb-2" style="color: var(--text-color);">Modules</h2>
             <div id="module-list" class="flex-grow bg-gray-900 rounded-md p-2 overflow-y-auto space-y-2" style="background-color: var(--bg-color);">
                <div id="module-placeholder" class="module-placeholder">
                    <p>Save a timeline to create a module</p>
                </div>
             </div>
        </div>
    </div>
    
    <!-- File Explorer (Bottom) -->
    <div class="h-48 bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col w-full max-w-7xl mx-auto" style="background-color: var(--panel-color);">
        <h2 class="text-lg font-semibold mb-2" style="color: var(--text-color);">File Explorer</h2>
        <div id="file-explorer" class="flex-grow bg-gray-900 rounded-md p-2 overflow-auto" style="background-color: var(--bg-color);">
            <div id="file-explorer-placeholder" class="file-explorer-placeholder">
                <p>Drag & drop videos, GIFs, or folders here</p>
            </div>
            <div id="file-list" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-3"></div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div id="context-menu" class="hidden absolute bg-gray-700 border border-gray-600 rounded-md shadow-lg p-3 z-50 text-white w-48">
        <div class="flex flex-col gap-2">
            <label for="loop-count" class="text-sm font-medium">Loop Count:</label>
            <input type="number" id="loop-count" min="1" class="bg-gray-800 border border-gray-600 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50">
            <div class="flex items-center mt-2">
                <input type="checkbox" id="infinite-loop" class="h-4 w-4 rounded border-gray-500 bg-gray-800 text-blue-600 focus:ring-blue-500">
                <label for="infinite-loop" class="ml-2 text-sm">Infinite</label>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const fileExplorer = document.getElementById('file-explorer'), fileList = document.getElementById('file-list'), fileExplorerPlaceholder = document.getElementById('file-explorer-placeholder');
            const timeline = document.getElementById('timeline'), timelinePlaceholder = document.getElementById('timeline-placeholder');
            const videoPlayer = document.getElementById('video-player'), imagePlayer = document.getElementById('image-player');
            const playStopBtn = document.getElementById('play-stop-btn'), skipBtn = document.getElementById('skip-btn'), saveModuleBtn = document.getElementById('save-module-btn');
            const playIcon = document.getElementById('play-icon'), stopIcon = document.getElementById('stop-icon');
            const contextMenu = document.getElementById('context-menu'), loopCountInput = document.getElementById('loop-count'), infiniteLoopCheckbox = document.getElementById('infinite-loop');
            const moduleList = document.getElementById('module-list'), modulePlaceholder = document.getElementById('module-placeholder');

            // State
            let uploadedFiles = {}, timelineClips = [], savedModules = {};
            let currentClipIndex = -1, currentLoopCount = 1;
            let isPlaying = false, draggedItem = null, activeTimelineClipId = null;

            // --- File Explorer Logic ---
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => { fileExplorer.addEventListener(eName, preventDefaults); document.body.addEventListener(eName, preventDefaults); });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach(e => fileExplorer.addEventListener(e, () => fileExplorer.classList.add('bg-gray-700')));
            ['dragleave', 'drop'].forEach(e => fileExplorer.addEventListener(e, () => fileExplorer.classList.remove('bg-gray-700')));
            fileExplorer.addEventListener('drop', handleDrop);
            async function handleDrop(e) {
                fileExplorerPlaceholder.classList.add('hidden');
                for (let item of e.dataTransfer.items) { const entry = item.webkitGetAsEntry(); if (entry) await scanFiles(entry); }
            }
            async function scanFiles(item) {
                if (item.isDirectory) {
                    const entries = await new Promise(res => item.createReader().readEntries(res));
                    for (const entry of entries) await scanFiles(entry);
                } else { item.file(file => { if (file.type.startsWith('video/') || file.type === 'image/gif' || file.type === 'image/png') addFileToExplorer(file); }); }
            }
            function addFileToExplorer(file) {
                const fileId = `file-${Date.now()}-${Math.random()}`;
                uploadedFiles[fileId] = { file, url: URL.createObjectURL(file), type: file.type };
                const fileElement = document.createElement('div');
                fileElement.className = 'bg-gray-700 p-2 rounded-md text-center cursor-grab active:cursor-grabbing';
                fileElement.draggable = true;
                fileElement.id = fileId;
                fileElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto mb-1 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h6v6H4zm2 2v2h2V6H6zm6 0h6v6h-6zm2 2v2h2V8h-2zM4 14h6v6H4zm2 2v2h2v-2H6zm6 0h6v6h-6zm2 2v2h2v-2h-2z"></path></svg><p class="text-xs truncate">${file.name}</p>`;
                fileList.appendChild(fileElement);
                fileElement.addEventListener('dragstart', handleDragStart);
                fileElement.addEventListener('dragend', handleDragEnd);
            }

            // --- Drag & Drop Logic ---
            function handleDragStart(e) {
                draggedItem = e.target.closest('[draggable]');
                draggedItem.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedItem.id);
            }
            function handleDragEnd() { if (draggedItem) draggedItem.classList.remove('dragging'); draggedItem = null; }
            timeline.addEventListener('dragover', e => { e.preventDefault(); timeline.classList.add('bg-gray-700'); });
            timeline.addEventListener('dragleave', () => timeline.classList.remove('bg-gray-700'));
            timeline.addEventListener('drop', e => {
                e.preventDefault();
                timeline.classList.remove('bg-gray-700');
                const fileId = e.dataTransfer.getData('text/plain');
                if (uploadedFiles[fileId]) {
                    const newClip = {
                        id: `timeline-clip-${Date.now()}-${Math.random()}`,
                        fileId: fileId,
                        loop: 1,
                        isInfinite: uploadedFiles[fileId].type.startsWith('image/'),
                        skipNext: false
                    };
                    timelineClips.push(newClip);
                    renderClipOnTimeline(newClip);
                    if (timelineClips.length === 1) loadClip(0);
                }
            });

            // --- Timeline Rendering ---
            function renderClipOnTimeline(clipData) {
                if (timelinePlaceholder.isConnected) timelinePlaceholder.remove();
                const fileData = uploadedFiles[clipData.fileId];
                const clipElement = document.createElement('div');
                clipElement.id = clipData.id;
                clipElement.className = 'h-20 bg-blue-500 rounded-md flex-shrink-0 flex items-center justify-center p-2 relative';
                clipElement.style.width = '120px';
                clipElement.innerHTML = `<p class="text-white text-xs text-center truncate">${fileData.file.name}</p>`;
                timeline.appendChild(clipElement);
                clipElement.addEventListener('contextmenu', showContextMenu);
            }

            function clearTimelineDOM() {
                timeline.innerHTML = '';
                timeline.appendChild(timelinePlaceholder);
            }
            
            // --- Context Menu Logic ---
            function showContextMenu(e) {
                e.preventDefault();
                activeTimelineClipId = e.currentTarget.id;
                const clipData = timelineClips.find(c => c.id === activeTimelineClipId);
                const isImage = uploadedFiles[clipData.fileId].type.startsWith('image/');
                loopCountInput.disabled = clipData.isInfinite || isImage;
                infiniteLoopCheckbox.disabled = isImage;
                loopCountInput.value = clipData.loop;
                infiniteLoopCheckbox.checked = clipData.isInfinite || isImage;
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.classList.remove('hidden');
            }
            function hideContextMenu() { if (!contextMenu.classList.contains('hidden')) { contextMenu.classList.add('hidden'); activeTimelineClipId = null; }}
            document.addEventListener('click', hideContextMenu);
            contextMenu.addEventListener('click', e => e.stopPropagation());
            loopCountInput.addEventListener('change', e => { const clip = timelineClips.find(c => c.id === activeTimelineClipId); if (clip) clip.loop = Math.max(1, parseInt(e.target.value, 10)); });
            infiniteLoopCheckbox.addEventListener('change', e => {
                const clip = timelineClips.find(c => c.id === activeTimelineClipId);
                if (clip) { clip.isInfinite = e.target.checked; loopCountInput.disabled = e.target.checked; }
            });

            // --- Module Logic ---
            saveModuleBtn.addEventListener('click', () => {
                if (timelineClips.length === 0) return;
                const moduleName = prompt("Enter a name for this module:", "My Module");
                if (moduleName) {
                    const moduleId = `module-${Date.now()}`;
                    savedModules[moduleId] = { name: moduleName, clips: JSON.parse(JSON.stringify(timelineClips)) }; // Deep copy
                    renderModuleButton(moduleId, moduleName);
                }
            });

            function renderModuleButton(id, name) {
                if(modulePlaceholder.isConnected) modulePlaceholder.remove();
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-2 rounded-md text-white transition-colors';
                btn.style.backgroundColor = 'var(--module-color)';
                btn.textContent = name;
                btn.dataset.moduleId = id;
                btn.addEventListener('mouseenter', () => btn.style.backgroundColor = '#1d4ed8');
                btn.addEventListener('mouseleave', () => btn.style.backgroundColor = 'var(--module-color)');
                moduleList.appendChild(btn);
            }

            moduleList.addEventListener('click', (e) => {
                const target = e.target.closest('button[data-module-id]');
                if(target) {
                    const moduleId = target.dataset.moduleId;
                    loadModule(moduleId);
                }
            });

            function loadModule(moduleId) {
                const moduleData = savedModules[moduleId];
                if (!moduleData) return;
                stopPlayback();
                clearTimelineDOM();
                timelineClips = JSON.parse(JSON.stringify(moduleData.clips)); // Deep copy
                timelineClips.forEach(renderClipOnTimeline);
                if(timelineClips.length > 0) loadClip(0);
            }

            // --- Playback Logic ---
            playStopBtn.addEventListener('click', togglePlayback);
            skipBtn.addEventListener('click', skipToNext);
            videoPlayer.addEventListener('ended', handleClipEnd);
            function togglePlayback() {
                if (currentClipIndex === -1 && timelineClips.length > 0) { loadClip(0); }
                if (!timelineClips.length) return;
                isPlaying = !isPlaying;
                if (isPlaying) {
                    playIcon.classList.add('hidden'); stopIcon.classList.remove('hidden');
                    if(uploadedFiles[timelineClips[currentClipIndex].fileId].type.startsWith('video/')) videoPlayer.play();
                } else {
                    playIcon.classList.remove('hidden'); stopIcon.classList.add('hidden');
                    videoPlayer.pause();
                }
            }
            function handleClipEnd() {
                const clip = timelineClips[currentClipIndex];
                if (!isPlaying) return;
                if (clip.skipNext) { advanceToNextClip(); return; }
                if (clip.isInfinite) { videoPlayer.currentTime = 0; videoPlayer.play(); return; }
                if (currentLoopCount < clip.loop) { currentLoopCount++; videoPlayer.currentTime = 0; videoPlayer.play(); return; }
                advanceToNextClip();
            }
            function skipToNext() {
                if(currentClipIndex === -1 || !timelineClips.length) return;
                const clip = timelineClips[currentClipIndex];
                const file = uploadedFiles[clip.fileId];
                if(file.type.startsWith('video/')) { clip.skipNext = true; } else { advanceToNextClip(); }
            }
            function advanceToNextClip() {
                if (currentClipIndex + 1 < timelineClips.length) { loadClip(currentClipIndex + 1); } else { stopPlayback(); }
            }
            function loadClip(index) {
                if (index >= timelineClips.length) { stopPlayback(); return; }
                currentClipIndex = index;
                currentLoopCount = 1;
                const clip = timelineClips[index];
                clip.skipNext = false;
                const file = uploadedFiles[clip.fileId];
                if (file.type.startsWith('video/')) {
                    videoPlayer.classList.remove('hidden'); imagePlayer.classList.add('hidden');
                    videoPlayer.src = file.url; videoPlayer.load();
                    if(isPlaying) videoPlayer.play();
                } else {
                    videoPlayer.classList.add('hidden'); imagePlayer.classList.remove('hidden');
                    imagePlayer.src = file.url;
                }
                document.querySelectorAll('#timeline > div[id^="timeline-clip-"]').forEach(el => el.classList.remove('ring-2', 'ring-white'));
                document.getElementById(clip.id)?.classList.add('ring-2', 'ring-white');
            }
            function stopPlayback() {
                 isPlaying = false;
                 playIcon.classList.remove('hidden'); stopIcon.classList.add('hidden');
                 videoPlayer.pause();
                 if (timelineClips.length > 0) {
                    loadClip(0);
                    videoPlayer.currentTime = 0;
                 }
            }
        });
    </script>
</body>
</html>

